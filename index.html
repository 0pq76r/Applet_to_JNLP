<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Applet to JNLP</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    </head>
    <body>
        <div id="top">
            <p>To bypass the browsers cross origin policy cors-anywhere.herokuapp.com is used</p>
            <label>
                <input type="url" id="url" placeholder="Applet URL" value="">
            </label>
            <label>
                <button id="get">Get JNLP</button>
            </label>
        </div>
        <div id="bottom">
            <iframe id="output" style="visibility:hidden"></iframe>
        </div>

        <script>
         function doCORSRequest(url, printResult) {
             var xhr = new XMLHttpRequest();
             xhr.open('GET', url, true);
             xhr.onload = function () {
		 printResult("data:text/html;base64," +
			     btoa(xhr.response+
				  "<scr"+"ipt>"+
				  "window.addEventListener( 'message' , function(e) { e.source.postMessage( JSON.stringify({ "+
				  "\"title\":document.title,"+
				  "\"vendor\":window.location.hostname,"+
				  "\"applets\":[... document.getElementsByTagName('applet')].map("+
				  "e => {return Object.assign({}, ...Array.from(e.attributes).map("+
				  "a => {var obj=Object(); obj[a.nodeName]=a.value; return obj;}));})"+
				  " }), '*'); }, false);"+
				  "</scr"+"ipt>"));
             };
             xhr.send(null);
         }
         
         // Bind event
         (function() {
             var urlField = document.getElementById('url');
             var outputField = document.getElementById('output');
             outputField.onload = function() {
                 window.setTimeout(function(){outputField.contentWindow.postMessage("","*");},100);
             }
             document.getElementById('get').onclick = function(e) {
                 e.preventDefault();
                 doCORSRequest(urlField.value,
                               function printResult(result) {
                                   outputField.src = result;
                               });
             };
             window.addEventListener('message', function(e){
                 obj = JSON.parse(e.data);
                 console.log(obj);
		 obj.applets.forEach(function(applet){
                     jnlp = document.createElement("a");
                     jnlp.href="data:application/octet-stream;base64,"+btoa(
			 '<?xml version="1.0" encoding="UTF-8"?>\n'+
			 '<jnlp spec="1.0+" codebase="" href="">\n'+
			 '  <information>\n'+
			 '    <title>'+obj.title+'</title>\n'+
			 '    <vendor>'+obj.vendor+'</vendor>\n'+
			 '  </information>\n'+
			 '  <security>\n'+
			 '  <all-permissions />\n'+
			 '  </security>\n'+
			 '  <resources>\n'+
			 '    <jar href="'+applet.archive+'" main="true" />\n'+
			 '  </resources>\n'+
			 '  <applet-desc name="'+obj.title+'" main-class="'+applet.code+'" width="'+applet.width+'" height="'+applet.height+'">\n'+
			 '  </applet-desc>\n'+
			 '</jnlp>\n');
                     jnlp.download=obj.title+".jnlp";
		     jnlp.innerHTML=jnlp.download;
		     //                 a.click();
		     //                 document.body.removeChild(a);
		     jar = document.createElement("a");
		     jar.href=new URL(applet.archive, urlField.value);
		     jar.download=applet.archive;
		     jar.innerHTML=jar.download;
                     document.body.appendChild(jnlp);
                     document.body.appendChild(jar);
		 })
             },false);
	     
             var cors_api_host = 'cors-anywhere.herokuapp.com';
             var cors_api_url = 'https://' + cors_api_host + '/';
             var slice = [].slice;
             var origin = window.location.protocol + '//' + window.location.host;
             var open = XMLHttpRequest.prototype.open;
             XMLHttpRequest.prototype.open = function() {
                 var args = slice.call(arguments);
                 var targetOrigin = /^https?:\/\/([^\/]+)/i.exec(args[1]);
                 if (targetOrigin && targetOrigin[0].toLowerCase() !== origin &&
                     targetOrigin[1] !== cors_api_host) {
                     args[1] = cors_api_url + args[1];
                 }
                 return open.apply(this, args);
             };
         })();

        </script>
    </body>
</html>
